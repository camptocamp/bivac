image:
  repository: camptocamp/bivac
  tag: "2.4"
  pullPolicy: IfNotPresent

annotations:
  foo: bar

labels: {}

## Orchestrator Bivac will run on
#
orchestrator: kubernetes

## Let Bivac backup volumes from all namespaces
#
watchAllNamespaces: true

## URL where to Restic should push the backups
# This field is required
#
targetURL: ""

## Password used by Restic to encrypt the backups
# If left empty, a generated one will be used
#
resticPassword: ""

## Pre-shared key which protect the Bivac server
# If left empty, a generated one will be used
#
serverPSK: ""

## Additional environment variables
#
extraEnv: []

service:
  type: ClusterIP
  port: 8182

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #  cpu: 100m
  #  memory: 128Mi
  # requests:
  #  cpu: 100m
  #  memory: 128Mi

nodeSelector: {}

tolerations: []

affinity: {}

## Default provider config 
providers: |
  [providers]
    [providers.mysql]
    pre_cmd = """
    mkdir -p $volume/backups && \
    echo $(if [ -z '$MYSQL_ROOT_PASSWORD' ]; then \
      mysqldump --all-databases --extended-insert --user=$MYSQL_USER --password=$MYSQL_PASSWORD; else \
      mysqldump --all-databases --extended-insert --password=$MYSQL_ROOT_PASSWORD; \
    fi) > $volume/backups/all.sql"""
    detect_cmd = "[[ -d $volume/mysql ]]"
    post_cmd = "rm -rf $volume/backups"
    backup_dir = "backups"

    [providers.postgresql]
    pre_cmd = "mkdir -p $volume/backups && pg_dumpall --clean -Upostgres > $volume/backups/all.sql"
    post_cmd = "rm -rf $volume/backups"
    detect_cmd = "[[ -f $volume/PG_VERSION ]]"
    backup_dir = "backups"

    [providers.openldap]
    pre_cmd = "mkdir -p $volume/backups && slapcat > $volume/backups/all.ldif"
    detect_cmd = "[[ -f $volume/DB_CONFIG ]]"
    backup_dir = "backups"

    [providers.mongo]
    pre_cmd = """
    if [ -z '$MONGO_INITDB_ROOT_USERNAME' ]; then \
      mongodump -o $volume/backups; else \
      mongodump -o $volume/backups --username=$MONGO_INITDB_ROOT_USERNAME --password=$MONGO_INITDB_ROOT_PASSWORD; \
    fi"""
    post_cmd = "rm -rf $volume/backups"
    detect_cmd = "[[ -f $volume/mongod.lock ]]"
    backup_dir = "backups"
